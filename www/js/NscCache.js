GC.Core.executing("/gc/sm/static/libs/NscCache.js");function MemoryStorage(){}MemoryStorage.prototype.setItem=function(e,a){this[e]=a;return this};MemoryStorage.prototype.getItem=function(e){return this[e]};function JsonStorage(){}JsonStorage.prototype.getItem=function(e){try{return JSON.parse(localStorage.getItem(e))}catch(a){return null}};JsonStorage.prototype.setItem=function(e,a){try{localStorage.setItem(e,JSON.stringify(a))}catch(b){}return this};
GC.localStorage=GC.supportLS?new JsonStorage:new MemoryStorage;function Cache(e){this._key=e;this._storage={}}Cache.clear=function(){try{localStorage.clear()}catch(e){}};Cache.prototype.reset=function(){this._storage={};this.save();return this};Cache.prototype.init=function(){this._storage=GC.localStorage.getItem(this._key)||{};var e=!1,a;for(a in this._storage)this.expired(this._storage[a])&&(delete this._storage[a],e=!0);e&&this.save();return this};
Cache.prototype.expired=function(e){return e&&e instanceof Object&&e._expire&&e._expire<(new Date).getTime()};Cache.prototype.getFromCache=function(e){return(e=this._storage[e])&&!this.expired(e)?e:null};
Cache.prototype.get=function(e,a,b){if(e instanceof Array){for(var c={},d=[],f=0,g=e.length;f<g;f++){var h=e[f],i=this.getFromCache(h);i?c[h]=i:d.push(h)}d.length?this.fetchBatch(d,function(b){for(var f=0,g=d.length;f<g;f++){var h=d[f];h in b?(c[h]=b[h],this.set(h,b[h])):(c[h]=null,this.set(h,null))}this.save();a(c)}.bind(this),b):a(c)}else{if(e in this._storage&&(i=this.getFromCache(e)))return a(i);this.fetch(e,function(c){this.set(e,c).save();a(c)}.bind(this),b)}};
Cache.prototype.set=function(e,a){this._storage[e]=a;return this};Cache.prototype.del=function(e){delete this._storage[e];return this};Cache.prototype.expire=function(e){e in this._storage&&this._storage[e]&&this._storage[e]instanceof Object&&(this._storage[e]._expire=1)};Cache.prototype.save=function(){GC.localStorage.setItem(this._key,this._storage);return this};Cache.prototype.fetch=function(){throw this._key+"::fetch not implemented";};
Cache.prototype.fetchBatch=function(){throw this._key+"::fetchBatch not implemented";};Cache.prototype._chunk=function(e,a,b,c,d){for(var f=a instanceof Array?a.slice(0):[a],g=[],h={};f.length;)g.push(f.splice(0,20));GC.Utils.each_a(g,function(a,d){e.get(b(a),function(b){for(var f=0,g=a.length;f<g;f++){var e=a[f],j=c(b[e]);j&&(h[e]=j)}d()},function(){for(var b=0,f=a.length;b<f;b++){var g=c(null);g&&(h[a[b]]=g)}d()})},function(){a instanceof Array?d(h):d(h[a])})};
var Users,Profiles,Friends,Recents,GameStats,Messages,SystemMessages,Countries,FRequests,ForumSummary,Categories,Subjects;
GC.Core.include("/gc/sm/static/libs/utils.js",function(e){Users=function(a){Cache.call(this,"user");this.m_http=a;this.m_privates=[]};Users.prototype=new Cache;Users.prototype.addPrivate=function(a){this.m_privates.push(a);return this};Users.prototype.get=function(){return this._storage};Users.prototype.set=function(a){this._storage=a;e.cookie("airGAPIKey",a.apiKey,{expires:7,path:"/"});return this.save()};Users.prototype.setTubeId=function(a){this._storage.tubeId=a;return this.save()};Users.prototype.setApiKey=
function(a){this._storage.apiKey=a;return this.save()};Users.prototype.auth=function(a,b){var c=GC.Utils.parseUrl(""+document.location),d=this;if(c.query.signout)return Cache.clear(),b({status:401});GC.Utils.chain(function(b){c.query.apiKey?d.me(c.query.apiKey,a,function(){b()}):b()},function(b){var g=d.get();c.query.airg&&g.apiKey?d.airgex(c.query.airg,g.userId,g.apiKey,a,function(a){404==a&&delete c.query.airg;b()}):b()},function(b){c.query.airg?d.airg(c.query.airg,a,function(){b()}):b()},function(b){var c=
d.get();c.apiKey?d.me(c.apiKey,a,function(){b()}):b()},function(b){var c=e.cookie("airGAPIKey");c?d.me(c,a,function(){b()}):b()},function(b){c.query.icode?d.icode(c.query.icode,a,function(){b()}):b()},function(b){c.query.pin?d.pin(c.query.pin,a,b):b()},function(a){a?b(a):b({status:401})})};Users.prototype.me=function(a,b,c){var d=this;this.m_http.request("GET","/1/me",{"api-key":a},null,function(c){c.user.apiKey=a;d.set(c.user);b(c.user)},function(a,b){401!=a?c({status:a,msg:b.msg}):c({status:a})})};
Users.prototype.airgex=function(a,b,c,d,f){var g=this;this.m_http.get("/1/airg/"+a,function(a){a==b?g.me(c,d,f):(g.reset(),f())},f)};Users.prototype.airg=function(a,b,c){var d=this;this.m_http.post("/1/users/register",{airg:a},function(a){d.set(a);b(a)},function(a,b){404!=a?c({status:a,msg:b.msg}):c()})};Users.prototype.icode=function(a,b,c){var d=this;this.m_http.get("/1/icodes/"+a,function(a){a.user?d.me(a.user.apiKey,b,c):c()},c)};Users.prototype.pin=function(a,b,c){var d=this;this.m_http.post("/1/users/login",
{pin:a},function(a){d.set(a);b(a)},c)};Users.prototype.singInOrUp=function(a,b,c,d){var f=this;this.m_http.post("/1/users/"+a,b,function(a){f.set(a);c(a)},d)};Users.prototype.login=function(a,b,c){this.signInOrUp("login",a,b,c)};Users.prototype.register=function(a,b,c){this.signInOrUp("register",a,b,c)};Users.prototype.reset=function(){e.cookie("airGAPIKey",null,{path:"/"});this.set({email:this._storage.email}).save();for(var a=0,b=this.m_privates.length;a<b;a++)this.m_privates[a].reset()};Profiles=
function(a,b,c){a&&(Cache.call(this,a+"Profiles"),this.init(),this.m_app=a,this.m_http=b,this.m_duration=parseInt(c)||6048E5)};Profiles.prototype=new Cache;Profiles.prototype._display=function(){return"Someone"};Profiles.prototype._default=function(){return{display:this._display(),_expire:(new Date).getTime()+6E4}};Profiles.prototype._construct=function(a){a.display||(a.display=this._display());return a};Profiles.prototype.set=function(a,b){b._expire||(b._expire=(new Date).getTime()+this.m_duration);
return Cache.prototype.set.call(this,a,b)};Profiles.prototype.fetch=function(a,b){var c=this;this._chunk(this.m_http,a,function(a){return"/1/profiles/"+a+",/"+c.m_app},function(a){return a?c._construct(a):c._default()},b)};Profiles.prototype.fetchBatch=function(a,b){this.fetch(a,b)};Profiles.prototype.validateDisplay=function(a){if(!a||"string"!=typeof a)return null;a=a.replace(/^\s+/,"").replace(/\s+$/,"");return a.match(/^[\w\d\-\' ]{3,}$/)?a:null};Presence=function(a){Profiles.call(this,"presence",
a,6E4)};Presence.prototype=new Profiles;Presence.prototype._default=function(){return{online:-1E6}};Presence.prototype._construct=function(a){return{online:a.online||-1E6}};Friends=function(a){Cache.call(this,"friends");this.m_http=a};Friends.prototype=new Cache;Friends.prototype.fetch=function(a,b,c){this.m_http.get("/1/contacts/"+a+"/friends",function(a){b({_expire:(new Date).getTime()+6048E5,friends:a})},c)};Friends.prototype.get=function(a,b,c){var d=this;Cache.prototype.get.call(this,a,function(c){c instanceof
Array?(d.set(a,{_expire:(new Date).getTime()+6048E5,friends:c}).save(),b(c)):b(c.friends)},c)};Friends.prototype.addFriend=function(a,b){var c=this;this.get(a,function(a){0>a.indexOf(b)&&(a.push(b),c.save())},function(){})};HooktFriends=function(a){Cache.call(this,"hookt");this.m_http=a};HooktFriends.prototype=new Cache;HooktFriends.prototype._display=function(){return"Someone"};HooktFriends.prototype.fetch=function(a,b,c,d){var a="/1/contacts/"+a+"/hookt",f=this;b&&(a+="?md5="+b);this.m_http.get(a,
function(a){for(var b=0,d=a.length;b<d;b++)a[b].display||(a[b].display=f._display());a.sort(function(a,b){return a.display.toLowerCase()<b.display.toLowerCase()?-1:1});c({la:(new Date).getTime(),friends:a})},d)};HooktFriends.prototype.get=function(a,b,c){var d=this,f=this.getFromCache(a),g;if(f)if(f.la+6E4<(new Date).getTime()){g=[];for(var h=0,e=f.friends.length;h<e;h++)g.push(f.friends[h].userId);g=GC.Utils.md5(JSON.stringify(g.sort()))}else return b(f.friends);this.fetch(a,g,function(c){d.set(a,
c).save();b(c.friends)},function(a,d){304==a?b(f.friends):c(a,d)})};AirGFriends=function(a){Cache.call(this,"airg");this.m_http=a};AirGFriends.prototype=new Cache;AirGFriends.prototype._display=function(){return"Someone"};AirGFriends.prototype.fetch=function(a,b,c){this.m_http.get("/1/contacts/"+a+"/airg",function(a){for(var c=0,g=a.length;c<g;c++)a[c].display||(a[c].display=self._display());a.sort(function(a,b){return a.display.toLowerCase()<b.display.toLowerCase()?-1:1});b({_expire:(new Date).getTime()+
864E5,friends:a})},c)};AirGFriends.prototype.get=function(a,b,c){var d=this.getFromCache(a),f=this;d?b(d.friends):this.fetch(a,function(c){f.set(a,c).save();b(c.friends)},c)};GamerFlags=function(a){Cache.call(this,"gamers");this.m_http=a};GamerFlags.prototype=new Cache;GamerFlags.prototype.fetch=function(a,b){this._chunk(this.m_http,a,function(a){return"/1/flags/"+a+",/enable"},function(a){return a||0},b)};GamerFlags.prototype.fetchBatch=function(a,b){this.fetch(a,b)};Recents=function(a){Cache.call(this,
"recents");this.m_http=a};Recents.prototype=new Cache;Recents.prototype.fetch=function(a,b,c){this.m_http.get("/1/gamebuds/"+a,b,c)};Recents.prototype.addBuds=function(a,b){var c=this;this.get(a,function(a){for(var f=!1,g=0,e=b.length;g<e;g++){var i=b[g];0>a.indexOf(function(a){return i.game==a.game&&i.userId==a.userId})&&(a.push(i),f=!0)}20<a.length&&a.splice(0,a.length-20);f&&c.save()},function(){})};GameStats=function(a){Cache.call(this,"gamestats");this.m_http=a};GameStats.prototype=new Cache;
GameStats.prototype.fetch=function(a,b){this.m_http.get("/1/gamestats/"+a,function(a){a._expire=(new Date).getTime()+6E4;b(a)},function(){b({win:0,loss:0,tie:0,played:0,_expire:(new Date).getTime()+1E4})})};GameStats.prototype.get=function(a,b,c,d){Cache.prototype.get.call(this,a+"/"+b,c,d)};Messages=function(a){Cache.call(this,a?a:"messages")};Messages.prototype=new Cache;Messages.prototype.init=function(){Cache.prototype.init.apply(this,arguments);for(var a in this._storage)e.each(this._storage[a].msgs,
function(a,c){c.created=new Date(c.created)})};Messages.prototype.expire=function(){return 6048E5};Messages.prototype.fetch=function(a,b){b({_expire:(new Date).getTime()+this.expire(),msgs:[]})};Messages.prototype.get=function(a,b,c){Cache.prototype.get.call(this,a,function(a){b(a.msgs)},c)};Messages.prototype.add=function(a,b){var c=this;Cache.prototype.get.call(this,a,function(d){d._expire=(new Date).getTime()+c.expire();d.msgs.push(b);20<d.msgs.length&&d.msgs.splice(0,d.msgs.length-20);c.set(a,
d).save()},function(){})};Messages.prototype._findAndModify=function(a,b,c){Cache.prototype.get.call(this,a,function(a){var f=a.msgs.indexOf(function(a){return a.msgId===b.msgId});0<=f&&c(a,f)},function(){})};Messages.prototype.put=function(a,b){this._findAndModify(a,b,function(c,d){c.msgs[d]=b;this.set(a,c).save()}.bind(this))};Messages.prototype.pull=function(a,b,c){if(b instanceof Function){var d=this;Cache.prototype.get.call(this,a,function(f){for(var e=[],h=[],i=0,k=f.msgs.length;i<k;i++)b(f.msgs[i])?
h.push(f.msgs[i]):e.push(f.msgs[i]);f.msgs=e;d.set(a,f).save();c&&c(h)},function(){})}else this._findAndModify(a,b,function(b,d){var e=b.msgs.splice(d,1);this.set(a,b).save();c&&c(e)}.bind(this))};FRequests=function(){Messages.call(this,"frequests")};FRequests.prototype=new Messages;FRequests.prototype.expire=function(){return 432E6};FRequests.prototype.init=function(a){Cache.prototype.init.call(this);var b=this._storage[a]||{msgs:[]},c=!1,d=[],f=(new Date).getTime(),g=this;e.each(b.msgs,function(a,
b){f-GC.Utils.date(b.created)<g.expire()?d.push(b):c=!0});c&&this.set(a,b).save()};FRequests.prototype.fetch=function(a,b){b({msgs:[]})};FRequests.prototype.add=function(a,b,c,d){var f=this;Cache.prototype.get.call(this,a,function(e){0>e.msgs.indexOf(function(a){return a.userId===b.userId})?(e.msgs.push(b),f.set(a,e).save(),c()):d()},d)};FRequests.prototype.count=function(a,b,c){this.get(a,function(a){b(a.length)},c)};FRequests.prototype.get=function(a,b,c){Cache.prototype.get.call(this,a,function(a){b(a.msgs)},
c)};IMsgs=function(){Messages.call(this,"imsgs")};IMsgs.prototype=new Messages;IMsgs.prototype.init=function(){Messages.prototype.init.call(this);var a=!1,b;for(b in this._storage)0==this._storage[b].msgs.length&&(delete this._storage[b],a=!0);a&&this.save()};IMsgs.prototype.actives=function(){var a=[],b;for(b in this._storage){var c=this._storage[b],d=0;if(0!=c.msgs.length){for(var f=c.msgs.length;0<f&&!c.msgs[f-1]._read;f--)d++;a.push({"new":d,targetId:b,last:c.msgs[c.msgs.length-1]})}}a.sort(function(a,
b){return a.count&&!b.count||b.count&&!a.count?b.count-a.count:GC.Utils.date(b.last.created).getTime()-GC.Utils.date(a.last.created)});return a};IMsgs.prototype.count=function(){var a=0,b;for(b in this._storage)for(var c=this._storage[b],d=c.msgs.length;0<d&&!c.msgs[d-1]._read;d--)a++;return a};IMsgs.prototype.read=function(a){var a=this._storage[a],b=!1;if(a){for(var c=a.msgs.length;0<c&&!a.msgs[c-1]._read;c--)a.msgs[c-1]._read=1,b=!0;b&&this.save()}};IMsgs.prototype.text=function(a,b){return a.text?
a.text:a.stringId?b(a.stringId):b("errorNotSupported")};IMsgs.prototype.pullAll=function(a,b){var c=[],d=this;GC.Utils.each(Object.keys(this._storage),function(b,e){d.pull(b,a,function(a){a.length&&(c=c.concat(a));e()})},function(){c.sort(function(a,b){return a.created-b.created});b(c)})};GameConfigs=function(a){Cache.call(this,"gameconfigs");this.m_http=a};GameConfigs.prototype=new Cache;GameConfigs.prototype.all=function(a,b){var c=this;this.m_http.get("/1/gameconfigs",function(b){for(var f in b)b[f]._expire=
(new Date).getTime()+36E5,c.set(f,b[f]);c.save();a(b)},b)};GameConfigs.prototype.get=function(a,b,c){var d=this.getFromCache(a);d?b(d):this.all(function(d){a in d?b(d[a]):c(404)},c)};Games=function(a){Cache.call(this,"games");this.m_http=a};Games.prototype=new Cache;Games.prototype.fetch=function(a,b){this._chunk(this.m_http,a,function(a){return"/1/games/"+a+","},function(a){a&&(a._expire=(new Date).getTime()+3E5);return a},b)};Games.prototype.fetchBatch=function(a,b,c){this.fetch.call(this,a,b,c)};
Games.prototype.get=function(a,b,c){Cache.prototype.get.call(this,a,function(d){d||a instanceof Array?b(d):c(404,{msg:"Game does not exist"})},c)};Games.prototype.all=function(a){var b=[],c;for(c in this._storage){var d=this._storage[c];d.game==a&&b.push(d)}return b};Countries=function(a){Cache.call(this,"countries");this.m_http=a;this.m_initialized=!1};Countries.prototype=new Cache;Countries.prototype.ALL="_";Countries.prototype.fetch=function(a,b,c){this.m_http.get("/1/countries",function(a){var c=
{list:[],id2name:{},name2id:{}};e.each(a,function(a,b){c.list.push({id:b.countryAbbr,name:b.countryName});c.id2name[b.countryAbbr]=b.countryName;c.name2id[b.countryName.toLowerCase()]=b.countryAbbr});c.list.sort(function(a,b){return a.name<b.name?-1:1});b(c)},c)};Countries.prototype.get=function(a,b){this.m_initialized||this.init();Cache.prototype.get.call(this,this.ALL,function(b){a(b.list)},b)};Countries.prototype.id=function(a,b,c){var d=this;this.get(function(){a=a.toLowerCase();a in d._storage[d.ALL].name2id?
b(d._storage[d.ALL].name2id[a]):c(404)},c)};Countries.prototype.name=function(a,b,c){var d=this;this.get(function(){a in d._storage[d.ALL].id2name?b(d._storage[d.ALL].id2name[countryName]):c(404)},c)};ForumSummary=function(a){Cache.call(this,"fsummary");this.m_http=a};ForumSummary.prototype=new Cache;ForumSummary.prototype.fetch=function(a,b,c){this.m_http.get("/1/forums/summaries",function(a){b({_expire:(new Date).getTime()+6E4,list:a})},c)};ForumSummary.prototype.save=function(){};ForumSummary.prototype.get=
function(a,b){Cache.prototype.get.call(this,"_",function(b){a(b.list)},b)};ForumSummary.prototype.del=function(){Cache.prototype.del.call(this,"_")};Categories=function(a){Cache.call(this,"categories");this.m_http=a};Categories.prototype=new Cache;Categories.prototype.fetch=function(a,b,c){this.m_http.get("/1/forums/categories",function(a){b({_expire:(new Date).getTime()+36E5,list:a})},c)};Categories.prototype.get=function(a,b){var c=this;Cache.prototype.get.call(this,"_",function(b){c.save();a(b.list)},
b)};Subjects=function(a){Cache.call(this,"subjects");this.m_http=a};Subjects.prototype=new Cache;Subjects.key=function(a,b){this.tId=function(){return a};this.sId=function(){return b};this.toString=function(){return a+b}};Subjects.prototype.construct=function(a){a._expire=(new Date).getTime()+6E4;return a};Subjects.prototype.fetch=function(a,b,c){var d=this;this.m_http.get("/1/forums/subjects/"+a.tId()+"/"+a.sId(),function(a){b(d.construct(a))},c)};Subjects.prototype.get=function(a,b,c,d){Cache.prototype.get.call(this,
new Subjects.key(a,b),c,d)};Subjects.prototype.save=function(){};Subjects.prototype.all=function(a,b,c,d,e){var g=this;this.m_http.get("/1/forums/subjects/"+a+"?offset="+b+"&size="+c,function(a){for(var b=0,c=a.length;b<c;b++){var e=a[b];g.set(new Subjects.key(e.tId,e._id),g.construct(e))}d(a)},e)};GC.Core.executed("/gc/sm/static/libs/NscCache.js")});
