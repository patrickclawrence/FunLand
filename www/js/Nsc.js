var Tuber={_gameName:"nsc",_started:!1,_toast:null,_handlers:[],_messages:[],_lastPoll:0,_subscribeId:0,_useWebSocket:0,_socket:null,_lastXhr:null,toast:function(d){Tuber._toast=d},init:function(d){Tuber._gameName=d;return Tuber},start:function(){Tuber._timer||(Tuber._timer=setInterval(function(){Tuber.keepAlive()},2E3));Tuber._lastPoll=(new Date).getTime();Tuber._started=!0;if(Tuber._useWebSocket){if(Tuber._socket)return;var d=io.connect("ws://"+GC.Utils.parseUrl(""+document.location).host,{port:81});
d.on("connect",function(){Tuber._socket=this;d.emit("get",{resource:"tubes",apiKey:Nsc.theUser.get().apiKey})});d.on("msg",function(d){Tuber.onMessage(d)});d.on("disconnect",function(){Tuber._started=false;Tuber._socket=null;io.sockets={}});d.on("error",function(d){io.sockets={};Tuber._started=false;Tuber._socket=null;Tuber.onError(d.status||400,d)})}else Tuber._lastXhr||(Tuber._lastXhr=Nsc.User.instance.tube(function(d){Tuber._lastXhr=null;Tuber._started&&Tuber.start();Tuber.onMessage(d)},function(d,
g){Tuber._lastXhr=null;if(d)Tuber.onError(d,g)}));return Tuber},onError:function(d,i){if(0!=d)if(401==d){Nsc.User.instance.setUser(null);Tuber._started=!1;for(var g=0,j=Tuber._handlers.length;g<j;g++)Tuber._handlers[g].onError(d,i)}else 409==d&&(Nsc.User.instance.setTubeId(i.tubeId).setApiKey(i.apiKey),Tuber.start())},onMessage:function(d){for(var i=[],g=0,j=d.length;g<j;g++){var e=!1,h=d[g];h.msgId||(h.msgId=GC.Utils.guid());for(var n=Tuber._handlers.length;0<n;n--){var k=Tuber._handlers[n-1];k&&
k.peek(d[g])&&k.handle(h)&&(e=!0)}e||i.push(h)}i.length&&Tuber._toast&&Tuber._toast.toast(d);return 0==i.length},keepAlive:function(){if(Tuber._started&&Nsc.User.instance.loggedIn()&&(null==Tuber._lastXhr||Tuber._lastPoll+7E4)<(new Date).getTime())Tuber._lastXhr=null,Tuber.start()},register:function(d){for(var i=[],g=0;g<Tuber._messages.length;g++){var j=Tuber._messages[g];(!d.peek(j)||!d.handle(j))&&i.push(j)}Tuber._messages=i;Tuber._handlers.push(d)},unregister:function(d){d=Tuber._handlers.indexOf(d);
0<=d&&Tuber._handlers.splice(d,1)},stop:function(){Tuber._lastXhr&&(Tuber._lastXhr.abort(),Tuber._lastXhr=null);clearInterval(Tuber._timer);Tuber._timer=null;Tuber._started=!1;Tuber._socket&&(Tuber._socket.disconnect(),Tuber._socket=null);Nsc.User.instance.unload()}};window.addEventListener("pageshow",function(d){d.persisted&&Tuber.start()});window.addEventListener("pagehide",function(d){d.persisted&&Tuber.stop()});window.addEventListener("unload",function(){Tuber.stop()});Tuber.Handler=function(){};
Tuber.Handler.prototype.onError=function(){};Tuber.Handler.prototype.handle=function(){return!1};Tuber.Handler.prototype.toast=function(){};Tuber.Handler.prototype.peek=function(){return!1};var Nsc={Unknown:"Someone"},Hookt={m_callbacks:[],resume:function(){jQuery.each(Hookt.m_callbacks,function(d,i){i()})},register:function(d){d instanceof Function&&Hookt.m_callbacks.push(d)}};GC.Core.executing("/gc/sm/static/libs/Nsc.js");
var deps=["/gc/sm/static/libs/NscCache.js","/gc/sm/static/libs/utils.js","/gc/sm/static/libs/jhttp.js","/gc/sm/static/libs/jquery-cookie.js"];Tuber._useWebSocket&&"undefined"==typeof io&&deps.push("/socket.io/socket.io.js");
GC.Core.include(deps,function(d){function i(){this.apiKey=null}function g(){Cache.call(this,"pokes")}function j(){}i.prototype=new JsonHttp;i.prototype.request=function(a,b,c,f,d,w){c||(c={});this.apiKey&&(c["api-key"]=this.apiKey);return JsonHttp.prototype.request.call(this,a,b,c,f,d,w)};var e=GC.Http=new i,h=Nsc.theUser=(new Users(e)).init(),n=Nsc.theProfiles=(new Profiles("default",e)).init(),k=Nsc.theDisplays=(new Profiles("display",e)).init(),x=Nsc.theStatus=(new Profiles("status",e)).init(),
y=Nsc.thePresence=(new Presence(e)).init(),q=Nsc.theGameConfigs=(new GameConfigs(e)).init(),l=Nsc.theFriends=new Friends(e),r=Nsc.theRecents=new Recents(e),s=Nsc.theStats=new GameStats(e),m=Nsc.theMessages=new Messages,t=Nsc.theFRequests=new FRequests,o=Nsc.theIMsgs=new IMsgs,u=Nsc.theHookt=new HooktFriends(e),z=Nsc.theAirG=new AirGFriends(e),p=Nsc.theGames=new Games(e),v=Nsc.theGamers=new GamerFlags(e);Nsc.theCountries=new Countries(e);Nsc.theForumSummary=new ForumSummary(e);Nsc.theCategories=(new Categories(e)).init();
Nsc.theSubjects=new Subjects(e);h.addPrivate(o);h.addPrivate(p);StaticVars=function(){Cache.call(this,"static")};StaticVars.prototype=new Cache;StaticVars.prototype.fetch=function(a,b){b(null)};Nsc.theStaticVars=(new StaticVars).init();Nsc.Events={GetFriends:1,start:function(a,b){d(window).trigger("nsc.events.start",{e:a,msg:b})},stop:function(a){d(window).trigger("nsc.events.stop",{e:a})},onStart:function(a){d(window).bind("nsc.events.start",a?a:function(a,c){c.msg&&GC.Wait.start(c.msg)})},onStop:function(a){d(window).bind("nsc.events.stop",
a?a:function(){GC.Wait.stop()})}};g.prototype=new Cache;g.prototype.fetch=function(a,b){return b({poke:0})};g.prototype.poke=function(a,b,c){var f=this,d=a+b;this.get(d,function(a){a.poke?c(!1):(f.set(d,{poke:1,_expire:(new Date).getTime()+6E4}),c(!0))},function(){c(!0)})};g.prototype.save=function(){};var A=new g;j.prototype.get=function(a,b,c){l.get(a,function(f){r.get(a,function(a){for(var c={},d=0,e=f.length;d<e;d++)c[f[d]]={};d=0;for(e=a.length;d<e;d++)c[a[d].userId]={};var g=Object.keys(c);
k.get(g,function(a){for(var f in c)c[f]=GC.Utils.merge({},a[f]),c[f].userId=f;y.get(g,function(a){var f=[],d;for(d in c)c[d].online=a[d].online,f.push(c[d]);f.sort(function(a,b){return 1==a.online&&1==b.online||0>a.online&&0>b.online?a.display.toLowerCase()<b.display.toLowerCase()?-1:1:0<a.online?-1:1});b(f)})})},c)},c)};var B=Nsc.theBuds=new j;Nsc.Facebook={appId:"187995777917493",_initialized:!1,initialize:function(a,b){if(Nsc.Facebook._initialized||d("#fb-root").get(0))return a();d("<div>").css("display",
"none").attr("id","fb-root").appendTo(d(document.body));var c=window.onerror;window.onerror=function(){};GC.Core.include("http://connect.facebook.net/en_US/all.js",function(){window.onerror=c;if("undefined"==typeof FB)return b();FB.init({appId:Nsc.Facebook.appId,cookie:!0,status:!0,xfbml:!0,oauth:!0});Nsc.Facebook._initialized=!0;a()})},login:function(a,b){FB.login(function(c){"connected"==c.status?FB.api("/me",function(b){a(c.authResponse.accessToken,b.id,b.email,b.name)}):b()},{scope:"email"})}};
Nsc.MsgHandler=function(a){this.m_game=a};Nsc.MsgHandler.prototype=new Tuber.Handler;Nsc.MsgHandler.prototype.onGameCreated=function(){return!1};Nsc.MsgHandler.prototype.onGameInvited=function(){return!1};Nsc.MsgHandler.prototype.onInvited=function(){return!1};Nsc.MsgHandler.prototype.onFriendRequest=function(){return!1};Nsc.MsgHandler.prototype.onTurnNotification=function(){return!1};Nsc.MsgHandler.prototype.peek=function(a){var b=this;a.created&&(a.created=GC.Utils.date(a.created));if(a.game)return p.set(a.gameId,
a.game),q.get(a.game.game,function(c){a._url=c.url+"?gameId="+a.gameId;a._game=a.game.game;m.add(h.get().userId,a);b.onGameCreated(a,c.title,a._game,a._url)},function(){}),!1;if(a.system){if(a.system.inviteUrl)return a.system.data&&a.system.data.game&&a.system.data.pin&&q.get(a.system.data.game,function(c){var f=a.system.data,c=c.url+"?icode="+f.pin;a._url=c;a._game=a.system.data.game;if(f.gameId)a.gameId=f.gameId;m.add(h.get().userId,a);if(f.gameId)b.onGameInvited(a,a.system.title,a._game,c);else b.onInvited(a,
a.system.title,f.game,c)},function(){}),!1;if(a.system.profile){switch(a.system.app){case "status":x.del(a.userId).save();break;default:n.del(a.userId).save(),k.del(a.userId).save()}return!1}if(a.system.friend)return l.del(h.get().userId).save(),!1;if(a.system.buds)return r.addBuds(h.get().userId,a.system.buds),!1;if(a.system.frequest)t.add(h.get().userId,a,function(){b.onFriendRequest(a)},function(){});else return!1}else if(a.msg){if(a.chatId)return!0;if(a.gameId)return a.msg&&a.msg.action?(p.get(a.gameId,
function(c){q.get(c.game,function(f){a._game=c.game;a._url=f.url+"?gameId="+c.gameId;m.add(h.get().userId,a);switch(a.msg.action){case "turn":b.onTurnNotification(a,f.title,a._url)}},function(){})},function(){}),!1):!0;if(a.targetId)return a.userId==Nsc.theUser.get().userId?o.add(a.targetId,a):o.add(a.userId,a),!0}else return!1};Nsc.User=function(){this.photoUrl="http://c.airg.ca/im/im/profile/{id}/{width}/{height}/1/1/{id}.png";this.avatarUrl="http://airgames.com/images/_avatars/01/{avatarId}.png";
this.airgUrl="http://c.airg.ca/im/gtf/";this.airgCrop="jpg/90/90/256/1/90/1";this.mode="airgames";this.user=this.tubeId=this.userId=null;Nsc.User.instance=this};Nsc.User.prototype.init=function(a){var b=this;this.get("/1/profileconfigs",function(c){b.photoUrl=c.photoUrl.replace("{category}","profile").replace("{type}","png");b.avatarUrl=c.avatarUrl;b.airgUrl=c.airgUrl;b.airgCrop=c.airgCrop;b.mode=c.mode;c.facebookId&&(Nsc.Facebook.appId=c.facebookId);h.auth(function(c){b.setUser(c);l.init();r.init();
s.init();m.init();o.init();t.init(c.userId);u.init();p.init();v.init();a()},a)},function(b){a({status:b})})};Nsc.User.prototype.setProfile=function(a,b,c){this.post("/1/profiles/"+this.userId+"/default",a,function(a){k.set(this.userId,k._construct(a)).save();b(a)}.bind(this),c)};Nsc.User.prototype.get=function(a,b,c){return e.get(a,b,c)};Nsc.User.prototype.post=function(){var a=Array.prototype.slice.call(arguments),b=a.shift(),c=a.pop(),f=a.pop(),d=JSON.stringify(a.pop()),a=a.pop()||{};return e.post(b,
a,d,f,c)};Nsc.User.prototype.put=function(a,b,c,f){return e.put(a,JSON.stringify(b),c,f)};Nsc.User.prototype.del=function(){var a=Array.prototype.slice.call(arguments),b=a.shift(),c=a.pop(),f=a.pop(),a=a.pop()||{};return e.del(b,a,f,c)};Nsc.User.prototype.logout=function(a,b){this.loggedIn()&&(Tuber.stop(),a||(a=function(){}),b||(b=function(){}),this.del("/1/devices/"+this.tubeId,a,b));this.setUser(null)};Nsc.User.prototype.gameStats=function(a,b,c){s.get(a,b,c)};Nsc.User.prototype.profile=function(a,
b){k.get(a,b)};Nsc.User.prototype.profiles=function(a,b){k.get(a,b)};Nsc.User.prototype.displays=function(a){this.get("/1/displays",a,function(){a([])})};Nsc.User.prototype.avatars=function(a,b){this.get("/1/avatars",a,b)};Nsc.User.prototype.countries=function(a,b){this.get("/1/countries",a,b)};Nsc.User.prototype.addBuds=function(a,b,c){r.addBuds(this.userId,a);this.buds(b,c)};Nsc.User.prototype.hookt=function(a,b){u.get(this.userId,a,b)};Nsc.User.prototype.airg=function(a,b){z.get(this.userId,a,
b)};Nsc.User.prototype.buds=function(a,b){B.get(this.userId,a,b)};Nsc.User.prototype.friends=function(a,b){l.get(this.userId,a,b)};Nsc.User.prototype.loggedIn=function(){return null!=this.user};Nsc.User.prototype.credential=function(a){if("string"!=typeof a)return null;if(a.match(/^[a-f0-9A-F]{32,32}$/))return{userId:a};if(a.match(/^\d{7,}$/))return 10==a.length&&(a="1"+a),{phonenumber:a};a=a.replace(/\s/g,"");return a.match(/.+@.+\..+/)?{email:a}:null};Nsc.User.prototype.setEmail=function(a,b,c){this.put("/1/users/"+
this.userId+"/email",a,b,c)};Nsc.User.prototype.setFacebookId=function(a,b,c){this.put("/1/users/"+this.userId+"/facebookId",a,b,c)};Nsc.User.prototype.delFacebookId=function(a,b){this.del("/1/users/"+this.userId+"/facebookId",a,b)};Nsc.User.prototype.password=function(a,b,c){this.credential(a)?this.post("/1/users/password",this.credential(a),b,c):c(400)};Nsc.User.prototype.setTubeId=function(a){this.tubeId=a;h.setTubeId(a);return this};Nsc.User.prototype.setApiKey=function(a){GC.Http.apiKey=a;h.setApiKey(a);
return this};Nsc.User.prototype.setUser=function(a){a?(this.userId=a.userId,this.tubeId=a.tubeId,this.user=a,GC.Http.apiKey=a.apiKey):(this.tubeId=this.userId="",this.user=null,h.reset(),GC.Http.apiKey=null)};Nsc.User.prototype.reset=function(){this.setUser(null)};Nsc.User.prototype.syncFriend=function(a,b){l.del(GC.Sm.user.userId);this.buds(a,b)};Nsc.User.prototype.addFriend=function(a,b,c){a=this.credential(a);if(!a)return c(400,{});this.post("/1/contacts/"+this.userId+"/friends",a,b,c)};Nsc.User.prototype.delFriend=
function(a,b,c){var f=this;this.del("/1/contacts/"+this.userId+"/friends/"+a,function(){l.del(f.userId);b()},c)};Nsc.User.prototype.accept=function(a,b,c){var f=this;this.post("/1/contacts/"+this.userId+"/friends",{rid:a},function(a){l.addFriend(f.userId,a);b(a)},c)};Nsc.User.prototype.postMsg=function(a,b,c,f){this.post("/1/imsgs/"+a,{_persist:1,text:b},function(b){b._read=1;o.add(a,b);c(b)},f)};Nsc.User.prototype._signin=function(a,b,c,f,d){b=this.credential(b);if(!b)return d(400,{});b.password=
c;var e=this;h.singInOrUp(a,b,function(a){e.setUser(a);f(a)},d)};Nsc.User.prototype.email=function(a,b,c){this.get("/1/emails/"+GC.Utils.escapeUrl(a),b,c)};Nsc.User.prototype.register=function(a,b,c,d){this._signin("register",a,b,c,d)};Nsc.User.prototype.login=function(a,b,c,d){this._signin("login",a,b,c,d)};Nsc.User.prototype.facebook=function(a,b){var c=this;Nsc.Facebook.initialize(function(){Nsc.Facebook.login(function(d,e,g,i){c.post("/1/users/register",{accessToken:d,facebookId:e,email:g,display:i},
function(b){h.set(b);c.setUser(b);a()},b)},b)},b)};Nsc.User.prototype.getGameConfig=function(a,b,c){p.get(a,function(a){q.get(a.game,b,c)},c)};Nsc.User.prototype.enqueue=function(a,b,c){this.post("/1/games/"+a,{queue:1},b,c)};Nsc.User.prototype.dequeue=function(a,b,c){this.post("/1/games/"+a,{queue:0},b,c)};Nsc.User.prototype.poke=function(a,b,c,d){var e=this;A.poke(a,b,function(g){g?e.notify(a,[b],{ping:1,query:"afk"},c,d):d(null)},d)};Nsc.User.prototype.setPassword=function(a,b,c){this.put("/1/users/"+
this.userId+"/password",a,b,c)};Nsc.User.prototype.notify=function(){var a=Array.prototype.slice.call(arguments,0),b=a.shift(),c=a.pop(),d=a.pop(),e=a.pop();userIds=a.pop();this.post("/1/games/"+b+"/messages"+(userIds?"/"+userIds:""),e,function(a){a.msg&&a.msg.text&&this.messages().add(b,a);d(a)}.bind(this),c)};Nsc.User.prototype.tube=function(a,b){return this.get("/1/tubes/"+this.tubeId,a,b)};Nsc.User.prototype.unload=function(){if(this.tubeId)return this.post("/1/tubes/"+this.tubeId,{sync:1},{unload:1},
function(){},function(){})};Nsc.User.prototype.messages=function(){return m};Nsc.User.prototype.getSystemMsgs=function(a,b){return this.messages().get(this.userId,a,b)};Nsc.User.prototype.chatMessages=function(a,b,c){m.get(a,b,c)};Nsc.User.prototype.scores=function(a,b,c){this.get("/1/scores/"+this.userId+"/"+a,b,c)};Nsc.User.prototype.createGame=function(a,b,c,d){this.post("/1/games",{game:a,users:b},c,d)};Nsc.User.prototype.createIcode=function(a,b,c,d){this.sendIcode({game:a,data:{gameId:b}},c,
d)};Nsc.User.prototype.sendIcode=function(a,b,c){this.post("/1/icodes?silent=1",a,b,c)};Nsc.User.prototype.queryIcode=function(a,b,c){this.get("/1/icodes/"+a,b,c)};Nsc.User.prototype.photo=function(a,b,c){return a.photoId?a.photoId.match(/\{crop\}/)?this.airgUrl+a.photoId.replace("{crop}",this.airgCrop)+".jpg":this.photoUrl.replace(/\{id\}/g,a.photoId).replace("{width}",b).replace("{height}",c):a.avatarId?this.avatar(a.avatarId):"/gc/sm/static/images/profile.png"};Nsc.User.prototype.avatar=function(a){return this.avatarUrl.replace("{avatarId}",
a)};Nsc.User.prototype.hideView=function(){this.put("/1/devices/"+this.deviceId+"/online",2,function(){},function(){})};Nsc.User.prototype.showView=function(){this.put("/1/devices/"+this.deviceId+"/online",1,function(){},function(){})};Nsc.User.prototype.inviteUser=function(a,b,c,d,e){c.game=a;c.data={gameId:b};this.post("/1/icodes",c,function(a){c.hooktId?v.get(hooktId,function(b){b?d(a):e(405)},e):d(a)},e)};Nsc.User.prototype.forumMod=function(a,b){this.get("/1/forums/mods/"+this.userId,a,b)};Nsc.User.prototype.forumSticky=
function(a,b,c,d,e){this.put("/1/forums/subjects/"+a+"/"+b+"/sticky",c?!0:!1,d,e)};Nsc.User.prototype.forumLock=function(a,b,c,d,e){this.put("/1/forums/subjects/"+a+"/"+b+"/lock",c?!0:!1,d,e)};Nsc.User.prototype.forumTopics=function(a,b,c){this.get("/1/forums/topics/"+a,b,c)};Nsc.User.prototype.forumGetPosts=function(a,b,c,d,e){this.get("/1/forums/posts/"+a+"?offset="+b+"&size="+c,d,e)};Nsc.User.prototype.forumCreatePost=function(a,b,c,d){this.post("/1/forums/posts/"+a,{text:""+b},c,d)};Nsc.User.prototype.forumCreateThread=
function(a,b,c,d,e){var g=this;this.post("/1/forums/subjects/"+a,{subject:b},function(a){g.forumCreatePost(a._id,c,function(b){d(a,b)},e)},e)};Nsc.User.prototype.forumDelThread=function(a,b,c,d){this.del("/1/forums/subjects/"+a+"/"+b,c,d)};Nsc.User.prototype.forumDelPost=function(a,b,c,d){this.del("/1/forums/posts/"+a+"/"+b,c,d)};Nsc.User.prototype.forumBan=function(a,b,c,d,e){this.post("/1/forums/bans",{userId:a,duration:b,reason:c},d,e)};GC.Core.executed("/gc/sm/static/libs/Nsc.js")});